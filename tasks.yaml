# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/maru-runner/main/tasks.schema.json
includes:
  - create: ./tasks/create.yaml
  - deploy: ./tasks/deploy.yaml
  - ansible: ./tasks/ansible.yaml
  - lab: ./tasks/lab.yaml
  - setup: https://raw.githubusercontent.com/defenseunicorns/uds-common/v1.22.0/tasks/setup.yaml

tasks:
####
#### Lab Environment k8s Management tasks ####
####
  - name: k3s-lab-up
    description: Stand up k3s cluster in lab environment
    actions:
      - task: lab:apply
        with:
          path: infra/envs/lab
          k8s_flavor: k3s
          cluster_id: lab-001
          inventory: inventory/nodes.yaml
          mode: up
      - task: lab:status
        with:
          path: infra/envs/lab
      - task: lab:kubeconfig
        with:
          path: infra/envs/lab

  - name: k3s-lab-down
    description: Tear down k3s cluster in lab environment
    actions:
      - task: lab:apply
        with:
          path: infra/envs/lab
          k8s_flavor: k3s
          cluster_id: lab-001
          inventory: inventory/nodes.yaml
          mode: down

  - name: k0s-lab-up
    description: Stand up k0s cluster in lab environment
    actions:
      - task: lab:apply
        with:
          path: infra/envs/lab
          k8s_flavor: k0s
          cluster_id: lab-001
          inventory: inventory/nodes.yaml
          mode: up
      - task: lab:status
        with:
          path: infra/envs/lab
      - task: lab:kubeconfig
        with:
          path: infra/envs/lab

  - name: k0s-lab-down
    description: Tear down k0s cluster in lab environment
    actions:
      - task: lab:apply
        with:
          path: infra/envs/lab
          k8s_flavor: k0s
          cluster_id: lab-001
          inventory: inventory/nodes.yaml
          mode: down

  - name: lab-kubeconfig
    description: Get the kubeconfig path for the lab environment
    actions:
      - task: lab:kubeconfig
        with:
          path: infra/envs/lab

  - name: lab-status
    description: Get the status of the lab environment
    actions:
      - task: lab:status
        with:
          path: infra/envs/lab

####
#### UDS package and bundle tasks ####
####
  - name: full-bootstrap
    description: Create and deploy the bootstrap bundle, then create a Keycloak user
    actions:
      - task: create-bootstrap-bundle
      - task: deploy-bootstrap-bundle
      - task: create-keycloak-user

  - name: create-bootstrap-bundle
    description: Create the core-secrets package and bootstrap bundle
    actions:
      - task: create:package
        with:
          path: packages/core-secrets
          architecture: amd64
      - task: create:bundle
        with:
          path: bundles/bootstrap-bundle
          architecture: amd64

  - name: deploy-bootstrap-bundle
    description: Deploy the bootstrap bundle to the cluster
    inputs:
      config_file_name:
        description: File name relative to the value of the path input var to use for the uds-config file
        default: uds-config.yaml
    actions:
      - task: deploy:deploy-bundle
        with:
          path: bundles/bootstrap-bundle
          config_file_name: ${{ .inputs.config_file_name }}
          architecture: amd64

  - name: create-keycloak-user
    description: Add a new keycloak user to the cluster for testing purposes
    actions:
      - task: setup:keycloak-user
        with:
          username: anthony
          first_name: Anthony
          last_name: Wendt
          group: "UDS Core/Admin"

####
#### Ansible tasks to prep fresh ubuntu nodes ####
####
  - name: ansible-prep
    description: Run Ansible node prep against the current ansible/inventory.ini to prep fresh ubuntu nodes
    actions:
      - task: ansible:prep
