# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/maru-runner/main/tasks.schema.json
includes:
  - create: ./tasks/create.yaml
  - deploy: ./tasks/deploy.yaml

variables:
  - name: K8S_FLAVOR
    default: k3s

  - name: CLUSTER_ID
    default: lab-001

  - name: INVENTORY
    default: inventory/nodes.yaml

  - name: TOFU_DIR
    default: infra/envs/lab

  - name: MODE
    default: up

tasks:
  - name: small:test
    actions:
      - cmd: |
          echo "This is a test task."
        shell:
          linux: bash

  - name: lab:init
    actions:
      - cmd: |
          set -euo pipefail
          cd "${TOFU_DIR}"
          tofu init
        shell:
          linux: bash

  - name: lab:up
    actions:
      - cmd: |
          set -euo pipefail
          cd "${TOFU_DIR}"
          TF_LOG=INFO tofu apply -auto-approve \
            -var="k8s_flavor=${K8S_FLAVOR}" \
            -var="cluster_id=${CLUSTER_ID}" \
            -var="inventory_file=${INVENTORY}" \
            -var="mode=${MODE}"
        shell:
          linux: bash

  - name: lab:kubeconfig
    actions:
      - cmd: |
          set -euo pipefail
          cd "${TOFU_DIR}"
          tofu output -raw kubeconfig_path
        shell:
          linux: bash

  - name: lab:status
    actions:
      - cmd: |
          set -euo pipefail
          cd "${TOFU_DIR}"
          KUBECONFIG="$(tofu output -raw kubeconfig_path)"
          kubectl --kubeconfig "$KUBECONFIG" get nodes -o wide
        shell:
          linux: bash

  - name: lab:down
    actions:
      - cmd: |
          UDS_MODE=down uds run lab:up
        shell:
          linux: bash

  - name: create-slim-base-bundle
    actions:
      - task: create:package
        with:
          path: packages/core-secrets
          architecture: amd64
      - task: create:bundle
        with:
          path: bundles/slim-base-bundle
          architecture: amd64

  - name: deploy-slim-base-bundle
    inputs:
      config_file_name:
        description: File name relative to the value of the path input var to use for the uds-config file
        default: uds-config.yaml
    actions:
      - task: deploy:deploy-bundle
        with:
          path: bundles/slim-base-bundle
          config_file_name: ${{ .inputs.config_file_name }}
          architecture: amd64
