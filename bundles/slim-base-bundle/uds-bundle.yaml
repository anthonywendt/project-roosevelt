# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/uds-cli/refs/heads/main/uds.schema.json
kind: UDSBundle
metadata:
  name: roosevelt-core-base-slim-dev
  description: A UDS bundle for deploying Istio and UDS Operator to a cluster
  version: "0.0.1"

packages:
  - name: init
    repository: ghcr.io/zarf-dev/packages/init
    ref: v0.68.1

  - name: metallb
    repository: ghcr.io/uds-packages/metallb
    ref: 0.15.2-uds.4-upstream

  # Deploy uds-core base functional layer which includes istio, uds-operator, and uds CRDs
  - name: core-base
    repository: ghcr.io/defenseunicorns/packages/uds/core-base
    ref: 0.58.1-upstream

# - name: minio-operator
  #   repository: ghcr.io/defenseunicorns/packages/private/uds/minio-operator
  #   ref: 7.1.1-uds.4-upstream
  #   overrides:
  #     minio-operator:
  #       uds-minio-config:
  #         values:
  #           # Test helm overrides to provision app specific buckets, policies and creds
  #           - path: apps
  #             value:
  #               - name: loki
  #                 namespace: loki
  #                 bucketNames:
  #                   - loki-chunks-bucket
  #                   - loki-ruler-bucket
  #                   - loki-admin-bucket
  #                 policy: ""
  #                 copyPassword:
  #                   enabled: true
  #                   secretName: "loki-minio"
  #                   secretIDKey: "access_key"
  #                   secretPasswordKey: "secret_key"
  #               - name: velero
  #                 namespace: velero
  #                 bucketNames:
  #                   - velero-bucket
  #                 policy: ""
  #                 copyPassword:
  #                   enabled: true
  #                   secretName: "velero-minio"
  #                   secretIDKey: "access_key"
  #                   secretPasswordKey: "secret_key"
  #       minio-tenant:
  #         values:
  #           - path: tenant.pools
  #             value:
  #               - servers: 4
  #                 name: pool-0
  #                 volumesPerServer: 4
  #                 size: 5Gi

  # - name: postgres-operator
  #   repository: ghcr.io/defenseunicorns/packages/uds/postgres-operator
  #   ref: 1.14.0-uds.12-upstream
  #   overrides:
  #     postgres-operator:
  #       uds-postgres-config:
  #         values:
  #           - path: postgresql
  #             value:
  #               enabled: true
  #               teamId: "uds"
  #               volume:
  #                 size: "10Gi"
  #               numberOfInstances: 3
  #               users:
  #                 keycloak.keycloak: [] # database owner
  #                 grafana.grafana: []
  #                 gitlab.gitlab: []
  #               databases:
  #                 keycloakdb: keycloak.keycloak
  #                 grafanadb: grafana.grafana
  #                 gitlabdb: gitlab.gitlab
  #               version: "16"
  #               ingress:
  #                 - remoteNamespace: keycloak
  #                 - remoteNamespace: grafana
  #                 - remoteNamespace: gitlab

  # - name: core-secrets
  #   path: ../../packages/core-secrets
  #   ref: 0.1.0
  #   exports:
  #     - name: KC_DB_PASSWORD

  # UDS core identity layer which includes keycloak and auth service
  # - name: core-identity-authorization
  #   repository: ghcr.io/defenseunicorns/packages/uds/core-identity-authorization
  #   ref: 0.55.1-upstream
  #   imports:
  #     - name: KC_DB_PASSWORD
  #       package: core-secrets
  #   overrides:
  #     keycloak:
  #       keycloak:
  #         values:
  #           - path: devMode
  #             value: false
  #           - path: postgresql.database
  #             value: keycloakdb
  #           - path: postgresql.username
  #             value: keycloak.keycloak
  #           - path: postgresql.host
  #             value: pg-cluster.postgres.svc.cluster.local
  #           - path: insecureAdminPasswordGeneration.enabled
  #             value: true
  #           - path: env[0]
  #             value:
  #               name: JAVA_OPTS_KC_HEAP
  #               value: "-XX:MaxRAMPercentage=70 -XX:MinRAMPercentage=70 -XX:InitialRAMPercentage=50 -XX:MaxRAM=1G"
  #         variables:
  #           - name: KC_DB_PASSWORD
  #             path: postgresql.password
  #           - name: KEYCLOAK_MEMORY_REQUEST
  #             description: "Memory request for the Keycloak pod"
  #             path: "resources.requests.memory"
  #             default: "512Mi"
  #           - name: KEYCLOAK_CPU_REQUEST
  #             description: "CPU request for the Keycloak pod"
  #             path: "resources.requests.cpu"
  #             default: "100m"
  #           - name: KEYCLOAK_MEMORY_LIMIT
  #             description: "Memory limit for the Keycloak pod"
  #             path: "resources.limits.memory"
  #             default: "1Gi"
  #           - name: KEYCLOAK_CPU_LIMIT
  #             description: "CPU limit for the Keycloak pod"
  #             path: "resources.limits.cpu"
  #             default: "1000m"
  #           - name: KEYCLOAK_WAYPOINT_HPA_ENABLED
  #             description: "Whether the HPA is enabled for the waypoint"
  #             path: "waypoint.horizontalPodAutoscaler.enabled"
  #             default: false
  #           - name: KEYCLOAK_WAYPOINT_CPU_REQUEST
  #             description: "CPU Requests for the waypoint"
  #             path: "waypoint.deployment.requests.cpu"
  #             default: "100m"
  #           - name: KEYCLOAK_WAYPOINT_MEMORY_REQUEST
  #             description: "Memory Requests for the waypoint"
  #             path: "waypoint.deployment.requests.memory"
  #             default: "64Mi"
  #           - name: KEYCLOAK_HEAP_OPTIONS
  #             description: "Sets the JAVA_OPTS_KC_HEAP environment variable in Keycloak"
  #             path: env[0].value
